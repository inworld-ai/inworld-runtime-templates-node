"use strict";
/**
 * Prompt Builder primitive using N-API addon.
 * Uses Jinja2 templating for dynamic prompt generation.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.PromptBuilder = void 0;
const node_api_1 = require("../../internal/node_api");
const errors_1 = require("../errors");
/**
 * Prompt Builder class.
 * Builds prompts from Jinja2 templates with variable substitution.
 *
 * @example
 * ```typescript
 * // Create prompt builder
 * const builder = await PromptBuilder.create(
 *   'Hello {{ name }}! You are {{ age }} years old.'
 * );
 *
 * // Render prompt
 * const prompt = await builder.build({ name: 'Alice', age: 25 });
 * console.log(prompt); // "Hello Alice! You are 25 years old."
 * ```
 */
class PromptBuilder {
    /**
     * Creates a new PromptBuilder instance (internal constructor).
     * Use `PromptBuilder.create()` static method instead.
     *
     * @param {any} builderInterface - Addon PromptBuilderInterface instance
     * @internal
     */
    constructor(builderInterface) {
        this.builderInterface = builderInterface;
    }
    /**
     * Creates a new PromptBuilder instance with the specified template.
     *
     * @param {string} template - Jinja2 template string
     * @returns {Promise<PromptBuilder>} Promise resolving to PromptBuilder instance
     * @throws {PromptBuilderError} If builder creation fails
     *
     * @example
     * ```typescript
     * // Simple template
     * const builder = await PromptBuilder.create('Hello {{ name }}!');
     *
     * // Complex template with conditions
     * const builder = await PromptBuilder.create(`
     *   {% if user_type == 'premium' %}
     *     Welcome back, premium member {{ name }}!
     *   {% else %}
     *     Welcome {{ name }}!
     *   {% endif %}
     * `);
     *
     * // Template with loops
     * const builder = await PromptBuilder.create(`
     *   Items:
     *   {% for item in items %}
     *   - {{ item.name }}: ${{ item.price }}
     *   {% endfor %}
     * `);
     * ```
     */
    static async create(template) {
        try {
            if (typeof template !== 'string') {
                throw new errors_1.PromptBuilderError('Template must be a string');
            }
            if (template.trim().length === 0) {
                throw new errors_1.PromptBuilderError('Template cannot be empty');
            }
            const env = (0, node_api_1.getInworldAddonEnv)();
            const llmNamespace = env.llm;
            if (!llmNamespace) {
                throw new errors_1.PromptBuilderError('LLM namespace not available in addon environment');
            }
            const factory = llmNamespace.createPromptBuildingFactory();
            const builderInterface = await factory.createJinjaPromptBuilder(template);
            return new PromptBuilder(builderInterface);
        }
        catch (error) {
            if (error instanceof errors_1.PromptBuilderError) {
                throw error;
            }
            throw new errors_1.PromptBuilderError(`Failed to create PromptBuilder instance: ${error.message}`, error.stack);
        }
    }
    /**
     * Builds a prompt by rendering the template with provided variables.
     *
     * @param {PromptVariables | string} variables - Variables as object or JSON string
     * @returns {Promise<string>} Rendered prompt string
     * @throws {PromptBuilderError} If prompt building fails
     *
     * @example
     * ```typescript
     * const builder = await PromptBuilder.create('Hello {{ name }}!');
     *
     * // With object
     * const prompt1 = await builder.build({ name: 'Alice' });
     *
     * // With JSON string
     * const prompt2 = await builder.build('{"name": "Bob"}');
     *
     * console.log(prompt1); // "Hello Alice!"
     * console.log(prompt2); // "Hello Bob!"
     * ```
     */
    async build(variables) {
        try {
            let variablesArg;
            if (typeof variables === 'string') {
                // Validate JSON string
                try {
                    JSON.parse(variables);
                    variablesArg = variables;
                }
                catch (_a) {
                    throw new errors_1.PromptBuilderError('Variables string must be valid JSON');
                }
            }
            else if (typeof variables === 'object' && variables !== null) {
                // Convert object to JSON string
                try {
                    variablesArg = JSON.stringify(variables);
                }
                catch (_b) {
                    throw new errors_1.PromptBuilderError('Variables object must be JSON-serializable');
                }
            }
            else {
                throw new errors_1.PromptBuilderError('Variables must be an object or JSON string');
            }
            const prompt = await this.builderInterface.build(variablesArg);
            if (typeof prompt !== 'string') {
                throw new errors_1.PromptBuilderError('Builder returned invalid prompt');
            }
            return prompt;
        }
        catch (error) {
            if (error instanceof errors_1.PromptBuilderError) {
                throw error;
            }
            throw new errors_1.PromptBuilderError(`Failed to build prompt: ${error.message}`, error.stack);
        }
    }
    /**
     * Validates that the template can be rendered with the given variables.
     * This is useful for checking templates before using them in production.
     *
     * @param {PromptVariables} variables - Variables to test
     * @returns {Promise<boolean>} True if template can be rendered, false otherwise
     *
     * @example
     * ```typescript
     * const builder = await PromptBuilder.create('Hello {{ name }}!');
     *
     * const isValid1 = await builder.validate({ name: 'Alice' });
     * console.log(isValid1); // true
     *
     * const isValid2 = await builder.validate({ wrong_key: 'value' });
     * console.log(isValid2); // false (missing 'name' variable)
     * ```
     */
    async validate(variables) {
        try {
            await this.build(variables);
            return true;
        }
        catch (_a) {
            return false;
        }
    }
}
exports.PromptBuilder = PromptBuilder;
