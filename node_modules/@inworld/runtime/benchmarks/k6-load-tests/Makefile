# Makefile for Runtime Load Testing

.PHONY: help install test test-local test-websocket test-voice test-stress clean results setup

# Default target
help:
	@echo "Runtime Load Test - Available commands:"
	@echo ""
	@echo "Setup:"
	@echo "  install     - Install k6 (macOS with brew)"
	@echo "  setup       - Create results directory and copy env file"
	@echo ""  
	@echo "Testing:"
	@echo "  basic-memory-test  - basic memory testing
	@echo ""
	@echo "Analysis:"
	@echo "  results     - Show latest test results summary"
	@echo "  clean       - Clean up results directory"
	@echo ""
	@echo "Configuration:"
	@echo "  HOST=<host> PORT=<port> make test-local"
	@echo "  VUS=<num> DURATION=<time> make test-local"

# Installation
install:
	@echo "Installing k6..."
	@which k6 || brew install k6
	@echo "k6 installation complete"

# Setup
setup:
	@echo "Setting up runtime load test environment..."
	@mkdir -p results
	@if [ ! -f .env ]; then cp env.example .env; echo "Created .env file from env.example"; fi
	@echo "Setup complete"

# Basic tests
test-local:
	@echo "Running local load test..."
	k6 run --vus=$${VUS:-10} --duration=$${DURATION:-30s} load-test.js

test-ws:
	@echo "Running WebSocket test..."
	k6 run --vus=$${VUS:-5} --duration=$${DURATION:-30s} websocket-test.js

test-voice:
	@echo "Running voice simulation test..."  
	k6 run --vus=$${VUS:-10} --duration=$${DURATION:-1m} voice-simulation-test.js

test-stress:
	@echo "Running stress test..."
	k6 run stress-test.js

# Advanced tests
test-all: test-local test-ws test-voice test-stress
	@echo "All tests completed"

# Test with full metrics export
test-export:
	@echo "Running load test with full metrics export..."
	@mkdir -p results
	k6 run \
		--summary-export=results/summary-$$(date +%Y%m%d-%H%M%S).json \
		--out json=results/metrics-$$(date +%Y%m%d-%H%M%S).json \
		load-test.js

# Results analysis  
results:
	@echo "Latest test results:"
	@if [ -f results/summary.json ]; then \
		cat results/summary.json | jq '.metrics | to_entries | .[] | select(.key | contains("http_req_duration") or contains("ws_") or contains("checks"))' 2>/dev/null || cat results/summary.json; \
	else \
		echo "No results found. Run 'make test-export' to generate detailed results."; \
	fi

# Show detailed metrics for specific test
results-detail:
	@echo "Detailed metrics from latest test:"
	@if [ -f results/metrics.json ]; then \
		echo "HTTP Request Duration (p95):"; \
		cat results/metrics.json | grep "http_req_duration" | grep "p(95)" | tail -1; \
		echo "WebSocket Connection Time:"; \
		cat results/metrics.json | grep "ws_connecting" | tail -1; \
		echo "Check Success Rate:"; \
		cat results/metrics.json | grep "checks" | tail -1; \
	else \
		echo "No detailed metrics found. Run 'make test-export' to generate detailed metrics."; \
	fi

# Cleanup
clean:
	@echo "Cleaning results directory..."
	@rm -rf results/*.json
	@echo "Results cleaned"

# Server management (assumes voice agent server is in relative path)
server-start:
	@echo "Starting voice agent server..."
	@cd ../../templates/ts/voice_agent && npm run start:server

server-check:
	@echo "Checking if voice agent server is running..."
	@curl -s "http://$${HOST:-localhost}:$${PORT:-4000}/health" > /dev/null && \
		echo "✅ Server is running" || \
		echo "❌ Server not responding. Run 'make server-start' first."

# Development helpers
dev-test: server-check test-local
	@echo "Development test complete"

# Performance analysis
perf-analysis:
	@echo "Performance Analysis:"
	@echo "====================="
	@make results-detail
	@echo ""
	@echo "Files in results directory:"
	@ls -la results/ 2>/dev/null || echo "No results directory found"

# Quick smoke test
smoke:
	@echo "Running quick smoke test (2 VUs, 10s)..."
	VUS=2 DURATION=10s make test-local
